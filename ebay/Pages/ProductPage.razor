@page "/product"
@using ebay.Base
@using ebay.Dtos
@inject IProductPageService _productPageService
@implements IDisposable

<div class="container">
    <h3 class="text-center my-4">Danh sách sản phẩm</h3>
    @*  PagingResult.TotalItems => render sp *@

    @* ============ TÌM KIẾM TÊN SP ==========  *@
    <div class="input-group mb-4">
        <input type="text" class="form-control" placeholder="Tìm kiếm sản phẩm..."
               @bind="_productPageService.Search" @bind:event="oninput" @onkeypress="OnEnter" />
        <button class="btn btn-primary" @onclick="()=>_productPageService.SetSearch()">
            <i class="fa fa-search"></i> Tìm kiếm
        </button>
    </div>



    @* ===========   DANH SÁCH SẢN PHẨM ======= *@
    <div class="row">
        @if (_productPageService.IsLoading)
        {
            <p>Đang tải dữ liệu...</p>
        }
        else if (_productPageService.PagingResult.TotalItems.Count == 0)
        {
            <p>Không có sản phẩm nào.</p>
        }
        else
        {
            @foreach (var product in _productPageService.PagingResult.TotalItems)
            {
                <ProductCard item="@product" />
            }
        }
    </div>

    @* =========== PHÂN TRANG  ===========*@
    @*  tổng số dữ liệu là 10003
        mỗi trang 10 sp
        tổng số trang = 1001 totalRow / pageSize
    
    
    
     *@
    <div class="d-flex justify-content-between my-4">

        @if (_productPageService.PagingResult != null)
        {
            <div>
                @* hiển thị từ sp thứ n đến  sp thứ m trong số  tổng sp  
                pageIndex = 2
                pageSize = 10
                totalRow = 103
                từ sp thứ 11 đến sp thứ 20 trong tổng số 103 sp

                11 = (2 -1) * 10 + 1
                20 = 2 * 10
                *@
                Hiển thị từ
                @((_productPageService.PageIndex - 1) * _productPageService.PageSize + 1)
                đến
                @(Math.Min(_productPageService.PageIndex * _productPageService.PageSize,
                            _productPageService.PagingResult.TotalRow))
                trong tổng số
                @_productPageService.PagingResult.TotalRow sản phẩm.



            </div>
        }
        @* <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item disabled">
                    <button class="page-link" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </button>
                </li>
                <li class="page-item active" aria-current="page">
                    <button class="page-link" @onclick="()=>_productPageService.SetPageIndex(1)">1</button>
                </li>
                <li class="page-item"><a class="page-link"  @onclick="()=>_productPageService.SetPageIndex(2)">2</a></li>
                <li class="page-item">
                    <button class="page-link" @onclick="()=>_productPageService.SetPageIndex(3)">3</button>
                </li>
                <li class="page-item">
                    <button class="page-link" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </button>
                </li>
            </ul>
        </nav> *@
<nav aria-label="Pagination">
            <ul class="pagination mb-0">
                <li class="page-item @(_productPageService.PageIndex <= 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => _productPageService.SetPageIndex(1)"
                        disabled="@(_productPageService.PageIndex <= 1)">
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                </li>
                <li class="page-item @(_productPageService.PageIndex <= 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => _productPageService.SetPageIndex(_productPageService.PageIndex - 1)"
                        disabled="@(_productPageService.PageIndex <= 1)">
                        <i class="fas fa-angle-left"></i>
                    </button>
                </li>


@* 
VD index =1
    Math.Max(1, _productPageService.PageIndex - 2)   => 1, -1 => 1
    Math.Min(_productPageService.TotalPages, _productPageService.PageIndex + 2)
                10001, 3=> 3



 *@
                @for (int page = Math.Max(1, _productPageService.PageIndex - 2); page <= Math.Min(_productPageService.TotalPages, _productPageService.PageIndex + 2); page++)
                {
                    var currentPage = page;
                    <li class="page-item @(currentPage == _productPageService.PageIndex ? "active" : "")">
                        <button class="page-link" @onclick="() => _productPageService.SetPageIndex(currentPage)">
                            @currentPage
                        </button>
                    </li>
                }

                <li class="page-item @(_productPageService.PageIndex >= _productPageService.TotalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => _productPageService.SetPageIndex(_productPageService.PageIndex + 1)"
                        disabled="@(_productPageService.PageIndex >= _productPageService.TotalPages)">
                        <i class="fas fa-angle-right"></i>
                    </button>
                </li>
                <li class="page-item @(_productPageService.PageIndex >= _productPageService.TotalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => _productPageService.SetPageIndex(_productPageService.TotalPages)"
                        disabled="@(_productPageService.PageIndex >= _productPageService.TotalPages)">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                </li>
            </ul>
        </nav>
       
    </div>


    <p></p>


</div>



@code {
    @*  quản lý ds sp trong state 
        page size, page index, search
         total record, total page
     *@

     
    // gọi loaddata
    protected override async Task OnInitializedAsync()
    {
        _productPageService.Onchange += StateHasChanged;
        await _productPageService.LoadData();
    }




    // bắt sự kiện enter
    private async Task OnEnter(KeyboardEventArgs e)
    {
        if(e.Key == "Enter")
        {
            await _productPageService.SetSearch();
        }
    }
    public void Dispose()
    {
        _productPageService.Onchange -= StateHasChanged;
    }



}